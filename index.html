<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=74752381-5ef1-4dbe-9ecf-9be7281c09f8&lang=ru_RU"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { width: 100%; height: 100%; }
        .controls { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            z-index: 1000; 
            background: white; 
            padding: 15px; 
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            max-width: 320px;
            width: 85%;
        }
        button { 
            padding: 14px 20px; 
            background: #007AFF; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 8px 0;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            transition: background 0.2s;
        }
        button:disabled {
            background: #CCCCCC;
            cursor: not-allowed;
        }
        button.cancel { background: #8E8E93; }
        button:hover:not(:disabled) { background: #0056CC; }
        button.cancel:hover:not(:disabled) { background: #6D6D72; }
        .address-info {
            background: #F7F7F8;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            border: 1px solid #E5E5EA;
            min-height: 60px;
        }
        .loading {
            color: #8E8E93;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60px;
        }
        .success-icon {
            color: #34C759;
            font-weight: bold;
            margin-right: 5px;
        }
        .error-icon {
            color: #FF3B30;
            font-weight: bold;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <div class="address-info" id="addressDisplay">
            <div class="loading">üìç –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞–¥—Ä–µ—Å–∞...</div>
        </div>
        <button id="confirmButton" onclick="confirmLocation()" disabled>‚úÖ –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å</button>
        <button class="cancel" onclick="goBack()">‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞</button>
    </div>

    <script>
        let map, placemark;
        let selectedCoords = null;
        let selectedAddress = "";
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        ymaps.ready(init);
        
        function init() {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const userCoords = [position.coords.latitude, position.coords.longitude];
                        createMap(userCoords);
                    },
                    function(error) {
                        // –ï—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ú–æ—Å–∫–≤—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        createMap([55.7558, 37.6173]);
                    },
                    { timeout: 10000 }
                );
            } else {
                createMap([55.7558, 37.6173]);
            }
        }
        
        function createMap(centerCoords) {
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
            map = new ymaps.Map('map', {
                center: centerCoords,
                zoom: 15,
                controls: ['zoomControl', 'fullscreenControl']
            });
            
            // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É
            placemark = new ymaps.Placemark(centerCoords, {}, {
                draggable: true,
                preset: 'islands#blueHomeIcon',
                iconColor: '#007AFF'
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
            map.geoObjects.add(placemark);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.events.add('click', function(e) {
                const coords = e.get('coords');
                updateLocation(coords);
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–µ—Ç–∫–∏
            placemark.events.add('dragend', function() {
                const coords = placemark.geometry.getCoordinates();
                updateLocation(coords);
            });
            
            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è
            updateLocation(centerCoords);
        }
        
        function updateLocation(coords) {
            selectedCoords = coords;
            placemark.geometry.setCoordinates(coords);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('addressDisplay').innerHTML = 
                '<div class="loading">üîç –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–¥—Ä–µ—Å...</div>';
            
            document.getElementById('confirmButton').disabled = true;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ø–Ω–¥–µ–∫—Å –ì–µ–æ–∫–æ–¥–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞
            ymaps.geocode(coords).then(function(res) {
                const firstGeoObject = res.geoObjects.get(0);
                
                if (firstGeoObject) {
                    selectedAddress = firstGeoObject.getAddressLine();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    document.getElementById('addressDisplay').innerHTML = 
                        `<span class="success-icon">‚úÖ</span><strong>–í—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å:</strong><br>${selectedAddress}`;
                    
                    document.getElementById('confirmButton').disabled = false;
                } else {
                    document.getElementById('addressDisplay').innerHTML = 
                        '<span class="error-icon">‚ùå</span> –ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                    document.getElementById('confirmButton').disabled = true;
                }
            }).catch(function(error) {
                document.getElementById('addressDisplay').innerHTML = 
                    '<span class="error-icon">‚ùå</span> –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞';
                document.getElementById('confirmButton').disabled = true;
            });
        }
        
        function confirmLocation() {
            if (!selectedCoords || !selectedAddress) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–µ');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            Telegram.WebApp.MainButton.showProgress();
            Telegram.WebApp.MainButton.setText('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...');
            Telegram.WebApp.MainButton.disable();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞
            Telegram.WebApp.sendData(JSON.stringify({
                latitude: selectedCoords[0],
                longitude: selectedCoords[1],
                address: selectedAddress,
                coordinates: `${selectedCoords[0].toFixed(6)}, ${selectedCoords[1].toFixed(6)}`,
                timestamp: new Date().toISOString()
            }));
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            setTimeout(() => {
                Telegram.WebApp.close();
            }, 1000);
        }
        
        function goBack() {
            Telegram.WebApp.close();
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        Telegram.WebApp.onEvent('webAppDataReceived', function(data) {
            console.log('Data received from bot:', data);
        });
    </script>
</body>
</html>